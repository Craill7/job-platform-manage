<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.recruit.mapper.JobsMapper">
    
    <resultMap type="Jobs" id="JobsResult">
        <result property="id"    column="id"    />
        <result property="companyId"    column="company_id"    />
        <result property="companyName"    column="company_name"    />
        <result property="department"    column="department"    />
        <result property="title"    column="title"    />
        <result property="type"    column="type"    />
        <result property="description"    column="description"    />
        <result property="techRequirements"    column="tech_requirements"    />
        <result property="bonusPoints"    column="bonus_points"    />
        <result property="minSalary"    column="min_salary"    />
        <result property="maxSalary"    column="max_salary"    />
        <result property="provinceId"    column="province_id"    />
        <result property="cityId"    column="city_id"    />
        <result property="addressDetail"    column="address_detail"    />
        <result property="workNature"    column="work_nature"    />
        <result property="requiredDegree"    column="required_degree"    />
        <result property="headcount"    column="headcount"    />
        <result property="requiredStartDate"    column="required_start_date"    />
        <result property="deadline"    column="deadline"    />
        <result property="createdAt"    column="created_at"    />
        <result property="updatedAt"    column="updated_at"    />
        <result property="status"    column="status"    />
        <result property="viewCount"    column="view_count"    />
        <result property="postedByUserId"    column="posted_by_user_id"    />
    </resultMap>


    <resultMap type="com.ruoyi.recruit.domain.JobAuditVo" id="JobAuditVoResult">
        <result property="id"               column="id" />
        <result property="companyName"      column="company_name" />
        <result property="title"            column="title" />
        <result property="typeName"         column="type_name" />
        <result property="workLocation"     column="work_location" />
        <result property="minSalary"        column="min_salary" />
        <result property="maxSalary"        column="max_salary" />
        <result property="workNature"       column="work_nature" />
        <result property="status"           column="status" />
        <result property="postedByUserName" column="posted_by_user_name" />
        <result property="createdAt"        column="created_at" />
        <result property="auditedAt"        column="audited_at" />
    </resultMap>

    <resultMap type="com.ruoyi.recruit.domain.JobDetailVo" id="JobDetailVoResult">
        <result property="id"               column="id" />
        <result property="companyName"      column="company_name" />
        <result property="title"            column="title" />
        <result property="typeName"         column="type_name" />
        <result property="department"       column="department" />
        <result property="minSalary"        column="min_salary" />
        <result property="maxSalary"        column="max_salary" />
        <result property="addressDetail"    column="address_detail" />
        <result property="workNature"       column="work_nature" />
        <result property="requiredDegree"   column="required_degree" />
        <result property="headcount"        column="headcount" />
        <result property="deadline"         column="deadline" />
        <result property="description"      column="description" />
        <result property="techRequirements" column="tech_requirements" />
        <result property="bonusPoints"      column="bonus_points" />
        <result property="postedByUserName" column="posted_by_user_name" />
        <result property="createdAt"        column="created_at" />
        <result property="status"           column="status" />
    </resultMap>

    <sql id="selectJobsVo">
        select j.id, j.company_id, j.department, j.title, j.type, j.description, j.tech_requirements, j.bonus_points, j.min_salary, j.max_salary, j.province_id, j.city_id, j.address_detail, j.work_nature, j.required_degree, j.headcount, j.required_start_date, j.deadline, j.created_at, j.updated_at, j.status, j.view_count, j.posted_by_user_id from jobs j
    </sql>

    <select id="selectJobsList" parameterType="Jobs" resultMap="JobsResult">
        <include refid="selectJobsVo"/>
        <if test="companyName != null and companyName != ''">
            left join companies c on j.company_id = c.company_id
        </if>
        <where>  
            <if test="companyId != null "> and j.company_id = #{companyId}</if>
            <if test="companyName != null and companyName != ''"> and c.company_name like concat('%', #{companyName}, '%')</if>
            <if test="title != null  and title != ''"> and j.title like concat('%', #{title}, '%')</if>
            <if test="type != null "> and j.type = #{type}</if>
            <if test="workNature != null "> and j.work_nature = #{workNature}</if>
            <if test="requiredDegree != null "> and j.required_degree = #{requiredDegree}</if>
            <if test="params.beginCreatedAt != null and params.beginCreatedAt != '' and params.endCreatedAt != null and params.endCreatedAt != ''"> and j.created_at >= #{params.beginCreatedAt} and j.created_at &lt; DATE_ADD(#{params.endCreatedAt}, INTERVAL 1 DAY)</if>
            <if test="status != null "> and j.status = #{status}</if>
        </where>
    </select>
    
    <select id="selectJobsById" parameterType="Long" resultMap="JobsResult">
        <include refid="selectJobsVo"/>
        where j.id = #{id}
    </select>

    <select id="selectJobAuditVoList" parameterType="Jobs" resultMap="JobAuditVoResult">
        SELECT
        j.id,
        j.title,
        j.min_salary,
        j.max_salary,
        j.work_nature,
        j.status,
        j.created_at,
        c.company_name,
        -- 关联岗位类别表
        tjc.name AS type_name,
        -- 拼接省份和城市作为工作地点
        CONCAT(IFNULL(tp.name, ''), IFNULL(tc.name, '')) AS work_location,
        -- 关联用户表获取发布人 (这里假设展示邮箱，若有昵称字段可换成 nick_name)
        u.email AS posted_by_user_name,
        -- 子查询获取最新的审核时间 (性能优化提示：如果数据量极大，建议在 jobs 表增加 audited_at 冗余字段)
        (SELECT created_at FROM job_audit_logs WHERE job_id = j.id ORDER BY created_at DESC LIMIT 1) AS audited_at
        FROM jobs j
        LEFT JOIN companies c ON j.company_id = c.company_id
        LEFT JOIN t_job_categories tjc ON j.type = tjc.id
        LEFT JOIN t_provinces tp ON j.province_id = tp.id
        LEFT JOIN t_cities tc ON j.city_id = tc.id
        LEFT JOIN users u ON j.posted_by_user_id = u.id
        <where>
            <if test="status != null">
                AND j.status = #{status}
            </if>
            <if test="title != null and title != ''">
                AND j.title LIKE concat('%', #{title}, '%')
            </if>
            <if test="companyName != null and companyName != ''">
                AND c.company_name LIKE concat('%', #{companyName}, '%')
            </if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND j.created_at &gt;= #{params.beginTime}
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND j.created_at &lt;= #{params.endTime}
            </if>
        </where>
        ORDER BY j.created_at DESC
    </select>

    <select id="selectJobDetailVoById" parameterType="Long" resultMap="JobDetailVoResult">
        SELECT
            j.id,
            c.company_name,
            j.title,
            tjc.name AS type_name,
            j.department,
            j.min_salary,
            j.max_salary,
            j.address_detail,
            j.work_nature,
            j.required_degree,
            j.headcount,
            j.deadline,
            j.description,
            j.tech_requirements,
            j.bonus_points,
            u.email AS posted_by_user_name,
            j.created_at,
            j.status
        FROM jobs j
                 LEFT JOIN companies c ON j.company_id = c.company_id
                 LEFT JOIN t_job_categories tjc ON j.type = tjc.id
                 LEFT JOIN users u ON j.posted_by_user_id = u.id
        WHERE j.id = #{id}
    </select>

    <insert id="insertJobs" parameterType="Jobs" useGeneratedKeys="true" keyProperty="id">
        insert into jobs
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="companyId != null">company_id,</if>
            <if test="department != null">department,</if>
            <if test="title != null">title,</if>
            <if test="type != null">type,</if>
            <if test="description != null">description,</if>
            <if test="techRequirements != null">tech_requirements,</if>
            <if test="bonusPoints != null">bonus_points,</if>
            <if test="minSalary != null">min_salary,</if>
            <if test="maxSalary != null">max_salary,</if>
            <if test="provinceId != null">province_id,</if>
            <if test="cityId != null">city_id,</if>
            <if test="addressDetail != null">address_detail,</if>
            <if test="workNature != null">work_nature,</if>
            <if test="requiredDegree != null">required_degree,</if>
            <if test="headcount != null">headcount,</if>
            <if test="requiredStartDate != null">required_start_date,</if>
            <if test="deadline != null">deadline,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="updatedAt != null">updated_at,</if>
            <if test="status != null">status,</if>
            <if test="viewCount != null">view_count,</if>
            <if test="postedByUserId != null">posted_by_user_id,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="companyId != null">#{companyId},</if>
            <if test="department != null">#{department},</if>
            <if test="title != null">#{title},</if>
            <if test="type != null">#{type},</if>
            <if test="description != null">#{description},</if>
            <if test="techRequirements != null">#{techRequirements},</if>
            <if test="bonusPoints != null">#{bonusPoints},</if>
            <if test="minSalary != null">#{minSalary},</if>
            <if test="maxSalary != null">#{maxSalary},</if>
            <if test="provinceId != null">#{provinceId},</if>
            <if test="cityId != null">#{cityId},</if>
            <if test="addressDetail != null">#{addressDetail},</if>
            <if test="workNature != null">#{workNature},</if>
            <if test="requiredDegree != null">#{requiredDegree},</if>
            <if test="headcount != null">#{headcount},</if>
            <if test="requiredStartDate != null">#{requiredStartDate},</if>
            <if test="deadline != null">#{deadline},</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="updatedAt != null">#{updatedAt},</if>
            <if test="status != null">#{status},</if>
            <if test="viewCount != null">#{viewCount},</if>
            <if test="postedByUserId != null">#{postedByUserId},</if>
         </trim>
    </insert>

    <update id="updateJobs" parameterType="Jobs">
        update jobs
        <trim prefix="SET" suffixOverrides=",">
            <if test="companyId != null">company_id = #{companyId},</if>
            <if test="department != null">department = #{department},</if>
            <if test="title != null">title = #{title},</if>
            <if test="type != null">type = #{type},</if>
            <if test="description != null">description = #{description},</if>
            <if test="techRequirements != null">tech_requirements = #{techRequirements},</if>
            <if test="bonusPoints != null">bonus_points = #{bonusPoints},</if>
            <if test="minSalary != null">min_salary = #{minSalary},</if>
            <if test="maxSalary != null">max_salary = #{maxSalary},</if>
            <if test="provinceId != null">province_id = #{provinceId},</if>
            <if test="cityId != null">city_id = #{cityId},</if>
            <if test="addressDetail != null">address_detail = #{addressDetail},</if>
            <if test="workNature != null">work_nature = #{workNature},</if>
            <if test="requiredDegree != null">required_degree = #{requiredDegree},</if>
            <if test="headcount != null">headcount = #{headcount},</if>
            <if test="requiredStartDate != null">required_start_date = #{requiredStartDate},</if>
            <if test="deadline != null">deadline = #{deadline},</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            <if test="status != null">status = #{status},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            <if test="postedByUserId != null">posted_by_user_id = #{postedByUserId},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteJobsById" parameterType="Long">
        delete from jobs where id = #{id}
    </delete>

    <delete id="deleteJobsByIds" parameterType="String">
        delete from jobs where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="countCurrentRecruitJobs" resultType="int">
        select count(1) from jobs
        where deadline >= CURDATE()
    </select>
</mapper>